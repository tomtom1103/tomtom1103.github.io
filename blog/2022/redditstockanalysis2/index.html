<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Sentiment analysis with Reddit API on /r/stocks - Pt.2 | Jonghyun (Thomas) Lee </title> <meta name="author" content="Jonghyun (Thomas) Lee"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="deep generative models"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/apple-touch-icon-precomposed.png?f3b0e00b51d3560daeef2cfef2a1c566"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://tomtom1103.github.io/blog/2022/redditstockanalysis2/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?ac1a8a24b4b1b97e0b04e951186c207f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Jonghyun</span> (Thomas) Lee </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/portfolio/">portfolio </a> </li> <li class="nav-item"> <a class="nav-link" href="/assets/pdf/Tom_Resume_0225.pdf" target="_blank" rel="noopener noreferrer">cv <span class="sr-only">(current)</span> </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Sentiment analysis with Reddit API on /r/stocks - Pt.2</h1> <p class="post-meta"> January 26, 2022 </p> <p class="post-tags"> <a href="/blog/2022"> <i class="fa-solid fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/category/pythonic"> <i class="fa-solid fa-tag fa-sm"></i> pythonic</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="contents">Contents</h2> <ul> <li>Text Cleaning using cleantext <ul> <li>Unix time and the Unix Epoch</li> </ul> </li> <li>Sentiment Analysis using flair</li> <li>Ticker parsing with list comprehensions</li> </ul> <h2 id="text-cleaning-using-cleantext">Text Cleaning using cleantext</h2> <p>Reddit API 로 /r/stocks 의 daily 포스팅을 성공적으로 가져왔으면, 해당 포스트들을 분석 하기 전 text cleaning 을 진행 해 주어야 한다. Reddit 의 포스트들은 기본적으로 embedded markdown 으로 작성되고 emoji 도 지원하기 때문에, raw text 들을 긁어오면 line break 와 마크다운 형식의 지저분한 텍스트를 마주한다.</p> <p>하지만 다행히도 /r/stocks 의 사용자들은 레딧 치곤 굉장히 점잖은 편이다. 포스팅을 할 때 사진을 첨부하지 않고, 줄바꿈도 거의 하지 않고 레딧의 특유의 밈 문화도 보이지 않는다 (물론 이 역할은 /r/stocks 의 큰형격인 <a href="https://www.reddit.com/r/wallstreetbets/" rel="external nofollow noopener" target="_blank">/r/wallstreetbets</a> 가 담당하고 있다).</p> <p>그렇기 때문에 수동 parsing 이나 NLTK 같은 무거운 라이브러리로 클리닝을 할 필요 없고, 가벼운 clean-text 라이브러리를 사용하였다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span>pip <span class="nb">install </span>clean-text
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">cleantext</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span> <span class="nf">cleaner</span><span class="p">(</span><span class="n">brr</span><span class="p">):</span>
    <span class="n">cleantitle</span> <span class="o">=</span> <span class="p">[</span><span class="nf">clean</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">]]</span>
    <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleantitle</span>

    <span class="n">cleanselftext</span> <span class="o">=</span> <span class="p">[</span><span class="nf">clean</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">selftext</span><span class="sh">'</span><span class="p">]]</span>
    <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">selftext</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleanselftext</span>

    <span class="n">realtime</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="nf">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">created_utc</span><span class="sh">'</span><span class="p">]]</span>
    <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">realtime</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">realtime</span>

    <span class="n">score</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="p">]]</span>
    <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
    <span class="k">return</span> <span class="n">brr</span>

</code></pre></div></div> <p>cleantext 모듈은 clean 이란 강력한 함수를 지원한다. to_ascii, no_emails 등 약 20개의 세부 인자를 제공하며, 굉장히 빠르다는게 큰 장점이다. 가벼운 모듈이기 때문에 딱히 documentation 도 없고, <a href="https://pypi.org/project/clean-text/" rel="external nofollow noopener" target="_blank">pypi 페이지</a> 에 나와있는 설명만으로도 가동이 가능하다. 이 cleantext 를 기반으로 cleaner 이란 함수를 만들었다. Reddit API 로 가져온 데이터프레임을 인자로 받으며, 각 칼럼에 대해 파싱을 진행한다. title, selftext 같은 str 값들은 전부 clean(text, lower=False) 로 파싱을 해주며, 해당 포스트의 추천수인 score 을 float 에서 int 로 바꿔준다.</p> <h4 id="unix-time-and-the-unix-epoch">Unix time and the Unix Epoch</h4> <p>created_utc 라는 칼럼값은 해당 포스트가 생성된 시간이다. 하지만 해당 시간은 우리가 익숙한 datetime 이 아닌 <a href="https://en.wikipedia.org/wiki/Unix_time" rel="external nofollow noopener" target="_blank">Unix Epoch time</a> 으로 로깅이 된다. 줄여서 Unix time 은 <strong>Unix Epoch</strong> 라는 시점부터 초단위로 시간을 표현하는 값인데, 이때 Unix Epoch 은 1970년 1월 1일 00시 00분을 의미한다. 대부분의 OS 는 시간을 계산할 때 이 Unix time 을 이용하고, 대부분의 언어는 기본 모듈에 Unix time 을 datetime 으로 바꿔주는 함수를 제공한다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">datetime</span>
<span class="nf">print</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">())</span> <span class="c1">#Current Unix time
</span><span class="nf">print</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="nf">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()))</span> <span class="c1">#Current datetime
</span></code></pre></div></div> <p>파이썬의 경우 time모듈의 time 함수가 현재 Unix time 을 리턴해주며, datetime모듈의 datetime 클래스의 fromtimestamp 함수가 Unix time 을 datetime 으로 바꿔서 리턴해준다. 그렇기 때문에 cleaner 함수에 이 부분을 추가하여 모든 포스팅이 작성된 시간을 datetime 으로 바꿔주었다.</p> <blockquote> <p>Unix time 관련해서 Y2K 사건과 비슷한 <a href="https://en.wikipedia.org/wiki/Year_2038_problem" rel="external nofollow noopener" target="_blank">Y2K38</a> 사건이 예정되어 있다. Unix time 을 32bit integer 값으로 저장하는 시스템들은 언젠간 \(2^{32}\) bit 까지 도달한 Unix time 을 처리하지 못하고 Unix time 을 Unix Epoch의 \(-2^{31}\) 초 <strong>전</strong>, 즉 1901년 12월 13일 로 롤백 할 것이다. 이 롤백은 2038년 1월 19일로 예정되어 있기 때문에 Y2K38 이란 이름이 붙었고, Y2K 와 준하는 사건이라고 보는 사람들도 있다.</p> </blockquote> <h2 id="sentiment-analysis-using-flair">Sentiment Analysis using flair</h2> <p>감성분석을 해주는 파이썬 라이브러리는 굉장히 많이 존재한다. 대표적으로 NLTK 가 있는데, NLTK 라이브러리는 모듈 뿐만 아니라 데이터셋, 그리고 튜토리얼 까지 포함되어 있는 라이브러리라 굉장히 무겁다. 그렇기 때문에 NLTK 대신 훨씬 가볍고 감성분석의 새로운 강자로 떠오르고 있는 flair 모듈을 사용하였다.</p> <p><a href="https://github.com/flairNLP/flair" rel="external nofollow noopener" target="_blank">flair</a> 은 sota NLP 모델들을 제공하는 모듈이다. NER, PoS, text embedding 같은 NLP 라이브러리의 기본을 다 갖추고 있고, PyTorch 에 직접 구축되어 있기 때문에 새로운 데이터와 모델생성이 쉽다. 심지어 flair 가 지원하는 대부분의 모델들은 <a href="https://huggingface.co/models?library=flair&amp;sort=downloads" rel="external nofollow noopener" target="_blank">HuggingFace model hub</a> 에 호스팅 되어있기 때문에 직접 다운로드가 가능하다. 이 프로젝트에선 flair 의 TextClassifier 모델을 사용하여 간단한 Positive/Negative rating 감성분석을 진행하였다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span>pip <span class="nb">install </span>flair
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">flair</span>
<span class="kn">from</span> <span class="n">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">sentiment_model</span> <span class="o">=</span> <span class="n">flair</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="n">TextClassifier</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="sh">'</span><span class="s">en-sentiment</span><span class="sh">'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">flairme</span><span class="p">(</span><span class="n">brr</span><span class="p">):</span>
    <span class="n">probability</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sentiment</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Analyzing Sentiment..</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">selftext</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_list</span><span class="p">()):</span>
        <span class="n">sentence</span> <span class="o">=</span> <span class="n">flair</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nc">Sentence</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">sentiment_model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
        <span class="n">probability</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">.</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">score</span><span class="p">)</span>
        <span class="n">sentiment</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">.</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span><span class="p">)</span>
    <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">probability</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">probability</span>
    <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">sentiment</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentiment</span>
    <span class="k">return</span> <span class="n">brr</span>
</code></pre></div></div> <p>위 코드는 brr 이란 데이터프레임을 인자로 받아 감성분석을 진행해주는 함수이다. flair 의 TextClassifier 은 문장을 파싱하여 해당 문장의 감성이 긍정적인지 부정적인지 리턴해주고, 해당 라벨의 score 도 리턴해준다. 하지만 여기서 주의할 점은 TextClassifier 은 그저 str 을 인자로 넣으면 감성을 리턴하진 않고, flair.data.Sentence 라는 함수로 str 을 flair.data.Sentence type 으로 전처리를 해주어야 한다. 해당 타입은 string-like 이며, iterable 하며 해당 string 값의 토큰을 iterate 한다. <strong>즉 flair.data.Sentence 는 NER tagging 을 진행해준다</strong>.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/posts/pythonic/redditstockanalysis2/1-480.webp 480w,/assets/img/posts/pythonic/redditstockanalysis2/1-800.webp 800w,/assets/img/posts/pythonic/redditstockanalysis2/1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/posts/pythonic/redditstockanalysis2/1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>위 코드를 보면 이해하기 쉽다. testdata는 Reddit API 로 가져온 약 1000개의 포스팅이 담겨있는 데이터프레임이며, 포스팅 본문은 [‘selftext’] 칼럼에 있다. [0] 인덱스로 하나의 포스트의 type 을 확인해 보면 일반적인 str 이지만, flair.data.Sentence(text) 로 파싱하여 sentence 의 type 을 확인 해 보면 flair.data.Sentence 이다. 이 sentence 는 str 와 언뜻 보면 비슷하지만 [0]로 인덱싱을 하면 하나의 문자열을 리턴하지 않고 token 을 리턴하는 것을 알 수 있다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sentiment_model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
<span class="n">probability</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">.</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">score</span><span class="p">)</span>
<span class="n">sentiment</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">.</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></div> <p>처음에 선언한 sentiment_model 엔 predict 라는 함수가 있다. 해당 함수가 실질적인 감성분석을 해주는 함수며, 내부적으로 인자로 받은 sentence 에 label 을 추가하여 리턴한다. sentence.labels[0].values 가 해당 문장의 Positive/Negative 태그이며, sentence.labels[0].score 가 해당 문장의 감성태그의 신뢰도 이다. 이 값들을 리스트에 저장하여 기존 인자로 받은 데이터프레임에 새로운 칼럼으로 선언하면 간단한 감성분석이 완료되는 것이다.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/posts/pythonic/redditstockanalysis2/2-480.webp 480w,/assets/img/posts/pythonic/redditstockanalysis2/2-800.webp 800w,/assets/img/posts/pythonic/redditstockanalysis2/2-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/posts/pythonic/redditstockanalysis2/2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>리턴해주는 데이터프레임을 불러오면 해당 포스트에 대한 감성과 신뢰도가 추가된 것을 볼 수 있다.</p> <blockquote> <p>아무리 flair 같은 가벼운 모듈을 사용하였더라도 평균적으로 길이가 1000이 넘는 포스트를 NER tagging 하고 해당 태그를 통해 감성분석을 진행하기 때문에 해당 함수는 결코 빠르다고 할 수는 없다. tqdm 으로 확인 해본 결과 약 1000개의 포스팅을 순회하는데 걸리는 시간은 약 6분이다.</p> <p>위 사진의 21행을 주목해보자. 해당 포스트에서 Peloton 에 진입하기 좋은 시점인지 조언을 구하는데, 포스팅에 대한 감성분석은 Negative 이고 신뢰도가 무려 1이다. 공교롭게도 해당 포스트가 작성되고 이틀후, Peloton 은 하루만에 -23% 하락했다. 해당 포스트의 작성자마저 Peloton 에 대해 부정적으로 생각하고 있었지만 진입하기 좋은 시점이냐고 물어본 셈이다.</p> </blockquote> <h2 id="ticker-parsing-using-list-comprehension">Ticker Parsing using list comprehension</h2> <p>포스트에 대한 감성분석을 진행 하면 어떤 포스트가 감성분석으로 positive 인지 negative 인지 알 수 있다. 하지만 앞서 말했듯이 하나의 포스트는 평균적으로 1000자를 넘어가며, 사람들이 어떤 기업에 대해 어떻게 생각하는지 알기 위해 본문을 하나하나 읽을 수는 없다. 그렇기 때문에 이전에 만들어 둔 티커 리스트를 대차대조하며 어떤 포스트에 어떤 티커가 등장하는지 보여주는 함수를 짰다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">tickercount</span><span class="p">(</span><span class="n">brr</span><span class="p">):</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="p">[</span><span class="n">flair</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nc">Sentence</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">selftext</span><span class="sh">'</span><span class="p">]]</span> <span class="c1">#한 포스트를 센텐스화
</span>    <span class="n">sentences</span> <span class="o">=</span> <span class="p">[</span><span class="n">sentence</span><span class="p">.</span><span class="n">tokens</span> <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">]</span> <span class="c1">#센텐스를 토큰화
</span>    <span class="n">sentence_tokens</span> <span class="o">=</span> <span class="p">[[</span><span class="nf">str</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">]</span> <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">]</span>
    <span class="c1"># 토큰을 str list 화
</span>
    <span class="n">tickers</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_pickle</span><span class="p">(</span><span class="sh">'</span><span class="s">utils/tickers_big3.pkl</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">tickerlist</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">tickers</span><span class="p">[</span><span class="sh">'</span><span class="s">tickers</span><span class="sh">'</span><span class="p">])</span>

    <span class="n">fullcount</span><span class="o">=</span><span class="p">[]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Analyzing tickers..</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="n">sentence_tokens</span><span class="p">):</span>
        <span class="n">sentence</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
        <span class="n">sentence</span> <span class="o">=</span> <span class="nf">clean</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">tickercount</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickerlist</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nocount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">secondcount</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">if</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nocount</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tickercount</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s"> was mentioned </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s"> times in this post.</span><span class="sh">'</span><span class="p">)</span>

            <span class="n">secondcount</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tickercount</span><span class="p">)</span>
        <span class="n">fullcount</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">tickercount</span><span class="p">))</span>
    <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">tickerinfo</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">fullcount</span>
    <span class="n">replacer</span> <span class="o">=</span> <span class="n">brr</span><span class="p">.</span><span class="n">tickerinfo</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">[]</span><span class="sh">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">tickerinfo</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">replacer</span>
    <span class="k">return</span> <span class="n">brr</span>
</code></pre></div></div> <p>처음 함수를 짜기 시작했을 때 간단하게 해당 티커가 포스트에 있는지 확인하는 방법을 str.isin() 으로 테스트를 해봤으나, str.isin() 은 정확하지 않기 때문에 flair.data.Sentence 가 기본적으로 제공하는 토큰 파싱을 기반으로 티커가 있는지 확인하였다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">sentences</span> <span class="o">=</span> <span class="p">[</span><span class="n">flair</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nc">Sentence</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">selftext</span><span class="sh">'</span><span class="p">]]</span> <span class="c1">#한 포스트를 센텐스화
</span>    <span class="n">sentences</span> <span class="o">=</span> <span class="p">[</span><span class="n">sentence</span><span class="p">.</span><span class="n">tokens</span> <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">]</span> <span class="c1">#센텐스를 토큰화
</span>    <span class="n">sentence_tokens</span> <span class="o">=</span> <span class="p">[[</span><span class="nf">str</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">]</span> <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">]</span>
</code></pre></div></div> <p>먼저 데이터프레임의 포스트가 있는 [‘selftext’] 칼럼의 모든 포스트를 flair.data.Sentence type 으로 바꾸었다. 해당 데이터타입은 .tokens 라는 인자가 있으며, 해당 문장들을 토큰으로 바꿔준 뒤 모든 토큰을 다시 str 값으로 바꾸었다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">tickers</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_pickle</span><span class="p">(</span><span class="sh">'</span><span class="s">utils/tickers_big3.pkl</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">tickerlist</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">tickers</span><span class="p">[</span><span class="sh">'</span><span class="s">tickers</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div> <p>티커가 저장되어 있는 데이터프레임을 부르고, 모든 티커를 담고있는 tickerlist 를 정의하였다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">fullcount</span><span class="o">=</span><span class="p">[]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Analyzing tickers..</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="n">sentence_tokens</span><span class="p">):</span>
        <span class="n">sentence</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
        <span class="n">sentence</span> <span class="o">=</span> <span class="nf">clean</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">tickercount</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickerlist</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nocount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">secondcount</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">if</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nocount</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tickercount</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s"> was mentioned </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s"> times in this post.</span><span class="sh">'</span><span class="p">)</span>

            <span class="n">secondcount</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tickercount</span><span class="p">)</span>
        <span class="n">fullcount</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">tickercount</span><span class="p">))</span>
    <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">tickerinfo</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">fullcount</span>
    <span class="n">replacer</span> <span class="o">=</span> <span class="n">brr</span><span class="p">.</span><span class="n">tickerinfo</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">[]</span><span class="sh">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">brr</span><span class="p">[</span><span class="sh">'</span><span class="s">tickerinfo</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">replacer</span>
    <span class="k">return</span> <span class="n">brr</span>
</code></pre></div></div> <p>함수의 해당 부분이 실제로 포스팅에 어떤 티커가 등장하는지, 그리고 몇번 등장하는지 알려주는 함수다. 처음엔 list comprehension 으로 이중 for 문을 해결하려고 했지만, list comprehension 에서는 기본 for 문 처럼 새로운 변수를 선언하는 것이 불가능 하기 때문에 어쩔 수 없이 for 문으로 구축하였다. 다행히도 해당 함수는 flairme 함수보다 빠르고, 약 1000개의 포스팅을 파싱하는데 약 3분이 걸렸다.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/posts/pythonic/redditstockanalysis2/3-480.webp 480w,/assets/img/posts/pythonic/redditstockanalysis2/3-800.webp 800w,/assets/img/posts/pythonic/redditstockanalysis2/3-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/posts/pythonic/redditstockanalysis2/3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>최종적으로 리턴되는 데이터프레임은 다음과 같다. 해당 포스트에 티커에 대한 멘션이 없으면 0을, 티커에 대한 멘션이 있으면 해당 티커와 티커가 몇번 멘션되는지 추가가 되어있다.</p> <p>이 tickercount 함수를 짜면서 아직 해결하지 못한 문제들이 몇가지 있다. 예를 들어 /r/stocks 의 사용자들은 티커명 말고도 ATH (all time high), MDD (maximum draw down), VIX (Volitality index) 같은 약어들을 사용한다. 해당 약어들도 중요한 지표이기 때문에 모든 약어를 정리한 파일이 필요하다. 그리고 지금까지의 포스팅은 /r/stocks 감성분석의 제일 기초적인 뼈대만 마련한 것이지, 나아갈 수 있는 방향은 무궁무진하다. 해당 티커와 감성과 실제 주가의 시계열 분석과 같은 모듈을 계속 추가해 나갈 수 있을 것이다.</p> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Jonghyun (Thomas) Lee. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?da39b660470d1ba6e6b8bf5f37070b6e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>